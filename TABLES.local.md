# Supabase テーブル設計・管理（ローカル）

このドキュメントは、Supabaseで利用するテーブル構成やカラム情報、運用ルールをローカルで管理します。

---

## テーブル設計例

### test テーブル
| カラム名 | 型       | 制約        | 説明           |
|----------|----------|-------------|----------------|
| id       | integer  | PRIMARY KEY | 識別子         |
| name     | text     |             | サンプル名     |
| created_at | timestamp |             | 作成日時       |

#### CREATE TABLE構文
```sql
CREATE TABLE public.test (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name text,
  created_at timestamp with time zone DEFAULT timezone('utc', now())
);
```

---

### user_ai_settings テーブル
| カラム名        | 型         | 制約        | 説明                         |
|----------------|------------|-------------|------------------------------|
| id             | uuid       | PRIMARY KEY | 識別子（自動生成）           |
| user_id        | uuid       | NOT NULL    | SupabaseユーザーID           |
| dialog_model   | text       |             | 対話用途のモデル選択値       |
| stt_model      | text       |             | 音声認識用途のモデル選択値   |
| tts_model      | text       |             | 音声出力用途のモデル選択値   |
| slide_model    | text       |             | スライド生成用途のモデル選択値|
| research_model | text       |             | DeepResearch用途のモデル選択値|
| tool_model     | text       |             | ツール用途のモデル選択値     |
| updated_at     | timestamp  |             | 最終更新日時                 |

#### CREATE TABLE構文
```sql
CREATE TABLE public.user_ai_settings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id),
  dialog_model text,
  stt_model text,
  tts_model text,
  slide_model text,
  research_model text,
  tool_model text,
  updated_at timestamp with time zone DEFAULT timezone('utc', now())
);
```

#### UNIQUE制約追加（ON CONFLICTでuser_idを指定する場合必須）
- Supabaseのupsert（ON CONFLICT）でuser_idを指定する場合、user_idにUNIQUE制約が必要
- 1ユーザー1設定レコード運用にも合致

```sql
ALTER TABLE public.user_ai_settings
ADD CONSTRAINT user_ai_settings_user_id_unique UNIQUE (user_id);
```

#### RLS運用ルール
- RLS（Row Level Security）は必ず有効化する
- Policyは「user_id = auth.uid()」をusing/with check両方に指定しALL権限で作成
- INSERT/UPDATE時もCheck Expressionを必ず有効に

## 備考
- このファイルは`.gitignore`対象外です。
- コミット時に必要に応じて`TABLES.md`に移植してください。


-- ウェイクワード学習データテーブル
-- 単一責任原則：ウェイクワード学習状態・特徴量データのみを管理

CREATE TABLE IF NOT EXISTS wake_word_training (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  audio_features JSONB NOT NULL,
  training_count INTEGER NOT NULL DEFAULT 0,
  is_trained BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス作成
CREATE INDEX IF NOT EXISTS idx_wake_word_training_user_id ON wake_word_training(user_id);
CREATE INDEX IF NOT EXISTS idx_wake_word_training_is_trained ON wake_word_training(is_trained);

-- RLS (Row Level Security) 設定
ALTER TABLE wake_word_training ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分のデータのみアクセス可能
DROP POLICY IF EXISTS "Users can only access their own wake word training data" ON wake_word_training;
CREATE POLICY "Users can only access their own wake word training data"
ON wake_word_training
FOR ALL
USING (auth.uid() = user_id);

-- サービスロールは全データアクセス可能
DROP POLICY IF EXISTS "Service role can access all wake word training data" ON wake_word_training;
CREATE POLICY "Service role can access all wake word training data"
ON wake_word_training
FOR ALL
USING (auth.role() = 'service_role');

-- コメント追加
COMMENT ON TABLE wake_word_training IS 'ジャーニーウェイクワード学習データ管理テーブル';
COMMENT ON COLUMN wake_word_training.user_id IS 'ユーザーID（外部キー）';
COMMENT ON COLUMN wake_word_training.audio_features IS '音声特徴量データ（MFCC、エネルギー等）';
COMMENT ON COLUMN wake_word_training.training_count IS '学習回数（最大3回）';
COMMENT ON COLUMN wake_word_training.is_trained IS '学習完了フラグ（3回完了時にtrue）';
